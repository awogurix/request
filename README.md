# ラジオ番組用曲リクエスト受付システム

ラジオ番組のリスナーから曲リクエストを受け付けるWebアプリケーションです。
リアルタイムでリクエストを表示し、管理者が簡単に管理できる機能を搭載しています。

## 主な機能

### 1. リクエストフォーム（トップページ）
- 曲名、アーティスト名、ラジオネーム、メッセージを入力
- スパム防止のための簡易CAPTCHA（計算問題）
- レート制限（15分間に5回まで）
- リクエスト受付の停止/再開機能

### 2. 今日のリクエスト一覧（誰でも閲覧可能）
- 本日受付したリクエストをリアルタイム表示
- 30秒ごとに自動更新
- スマホ対応のレスポンシブデザイン

### 3. プレイリスト機能
- 管理者が投稿したプレイリストを誰でも閲覧可能
- SpotifyやYouTube等のリンクを共有
- 作成日時と説明文の表示

### 4. 管理画面（パスワード保護）
- 全期間のリクエスト管理
- 既読/未読の切り替え
- リクエスト削除機能
- 日付フィルター機能
- CSVエクスポート機能
- 統計情報表示
- リクエスト受付の停止/再開
- プレイリスト管理（追加・削除）
- 自動バックアップ機能（起動時・1時間ごと）
- 手動バックアップ作成・復元機能

## 技術スタック

- **バックエンド**: Node.js + Express
- **データベース**: SQLite
- **フロントエンド**: HTML, CSS, JavaScript（バニラJS）
- **フォント**: Noto Sans JP（Google Fonts）
- **セキュリティ**: bcryptjs, express-session, express-rate-limit

## 必要な環境

- Node.js（バージョン 14 以上推奨）
- npm（Node.jsに付属）

## インストール手順

### 1. プロジェクトのセットアップ

```bash
# 依存パッケージをインストール
npm install
```

### 2. サーバーの起動

```bash
# サーバーを起動
npm start
```

サーバーが起動すると、以下のメッセージが表示されます：
```
データベース接続成功
デフォルト管理者パスワード設定: admin123
サーバーが起動しました: http://localhost:3000
```

### 3. アプリケーションへのアクセス

ブラウザで以下のURLにアクセスしてください：

- **トップページ（リクエストフォーム）**: http://localhost:3000/
- **今日のリクエスト一覧**: http://localhost:3000/today.html
- **管理画面**: http://localhost:3000/admin.html

## 使い方

### リスナー向け

#### リクエストの送信方法

1. トップページにアクセス
2. 以下の項目を入力：
   - **曲名**（必須・100文字まで）
   - **アーティスト名**（必須・100文字まで）
   - **ラジオネーム**（必須・50文字まで）
   - **メッセージ**（任意・300文字まで）
3. CAPTCHA（計算問題）を解答
4. 「リクエストを送信」ボタンをクリック

#### 今日のリクエストを確認

1. 「今日のリクエスト」ページにアクセス
2. 本日受付したリクエストが新しい順に表示されます
3. ページは30秒ごとに自動更新されます

### 管理者向け

#### 初回ログイン

1. 管理画面（http://localhost:3000/admin.html）にアクセス
2. デフォルトパスワードを入力：`admin123`
3. ログインボタンをクリック

**重要**: セキュリティのため、初回ログイン後にパスワードを変更することを強くおすすめします。

#### リクエストの管理

##### 既読/未読の切り替え
- 各リクエストの「既読」または「未読」ボタンをクリック
- 未読のリクエストは黄色の背景で表示されます

##### リクエストの削除
- 削除したいリクエストの「削除」ボタンをクリック
- 確認ダイアログで「OK」を選択

##### 日付フィルター
- 日付選択ボックスから特定の日付を選択
- その日のリクエストのみが表示されます
- 「全期間」ボタンでフィルターをクリア

##### CSVエクスポート
- 「CSVエクスポート」ボタンをクリック
- 日付フィルターが設定されている場合、その日のデータのみエクスポート
- フィルターなしの場合、全期間のデータをエクスポート

#### バックアップ管理

##### 自動バックアップ
- サーバー起動時に自動的にバックアップが作成されます
- その後、1時間ごとに自動バックアップが実行されます
- 最大10件のバックアップが保持され、古いものから自動削除されます
- バックアップファイルは `backups/` ディレクトリに保存されます

##### 手動バックアップの作成
1. 管理画面の「バックアップ管理」セクションへ移動
2. 「手動バックアップ作成」ボタンをクリック
3. バックアップが作成され、一覧に表示されます

##### コマンドラインからのバックアップ
```bash
# バックアップを作成
node backup.js

# または
node backup.js backup

# バックアップ一覧を表示
node backup.js list

# バックアップから復元
node backup.js restore <ファイル名>
```

##### バックアップからの復元
1. 管理画面の「バックアップ管理」セクションへ移動
2. 復元したいバックアップの「復元」ボタンをクリック
3. 確認ダイアログで「OK」を選択
4. サーバーを再起動して変更を反映

**注意**: 復元を実行すると、現在のデータベースは自動的にバックアップされます（`before_restore_*` という名前で保存）。

#### ログアウト
- 画面右上の「ログアウト」ボタンをクリック

## ファイル構成

```
radio-request-app/
├── server.js                 # サーバーサイドのメインファイル
├── backup.js                 # バックアップ管理スクリプト
├── package.json              # プロジェクト設定と依存関係
├── requests.db               # SQLiteデータベース（自動生成）
├── README.md                 # このファイル
├── backups/                  # バックアップファイル保存先（自動生成）
│   └── requests_*.db         # バックアップファイル
└── public/                   # 静的ファイル
    ├── index.html            # トップページ（リクエストフォーム）
    ├── today.html            # 今日のリクエスト一覧
    ├── admin.html            # 管理画面
    ├── playlist.html         # プレイリスト一覧
    ├── css/
    │   └── style.css         # スタイルシート
    └── js/
        ├── index.js          # トップページのスクリプト
        ├── today.js          # リクエスト一覧のスクリプト
        ├── admin.js          # 管理画面のスクリプト
        └── playlist.js       # プレイリストのスクリプト
```

## データベース構造

### requestsテーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー（自動採番） |
| song_name | TEXT | 曲名 |
| artist_name | TEXT | アーティスト名 |
| nickname | TEXT | ラジオネーム |
| message | TEXT | メッセージ（任意） |
| created_at | TEXT | 受付日時（日本時間、YYYY-MM-DD HH:MM:SS形式） |
| is_read | INTEGER | 既読フラグ（0=未読, 1=既読） |

### playlistsテーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー（自動採番） |
| title | TEXT | プレイリストのタイトル |
| url | TEXT | プレイリストのURL |
| description | TEXT | 説明（任意） |
| created_at | TEXT | 作成日時（日本時間） |

### settingsテーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー（自動採番） |
| key | TEXT | 設定キー（request_enabled等） |
| value | TEXT | 設定値（'1'または'0'） |

### adminテーブル
| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER | 主キー |
| password | TEXT | ハッシュ化されたパスワード |

## セキュリティ機能

### 1. スパム防止
- 簡易CAPTCHA（計算問題）
- レート制限（15分間に5回まで）

### 2. 管理画面の保護
- パスワード認証（bcryptによるハッシュ化）
- セッション管理（24時間有効）

### 3. 入力バリデーション
- 文字数制限
- 必須項目チェック
- XSS対策（HTMLエスケープ処理）

## カスタマイズ方法

### ポート番号の変更

環境変数`PORT`を設定するか、`server.js`の以下の行を編集：

```javascript
const PORT = process.env.PORT || 3000;
```

### 管理者パスワードの変更

データベースを削除して再生成するか、以下の手順で変更：

1. `server.js`の`initDatabase`関数内の以下の行を編集：
```javascript
const defaultPassword = 'admin123'; // 新しいパスワードに変更
```

2. `requests.db`ファイルを削除
3. サーバーを再起動

### レート制限の調整

`server.js`の`requestLimiter`設定を編集：

```javascript
const requestLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 時間枠（ミリ秒）
  max: 5, // 最大リクエスト数
  message: 'エラーメッセージ'
});
```

### 自動更新間隔の変更

`public/js/today.js`の以下の行を編集：

```javascript
const AUTO_REFRESH_INTERVAL = 30000; // ミリ秒（30000 = 30秒）
```

### デザインのカスタマイズ

`public/css/style.css`の`:root`セクションでカラースキームを変更：

```css
:root {
  --primary-color: #FF6B6B;    /* メインカラー */
  --secondary-color: #4ECDC4;  /* セカンダリーカラー */
  --accent-color: #FFE66D;     /* アクセントカラー */
  /* その他の色設定 */
}
```

## デプロイ方法

### Heroku（無料プラン終了のため代替推奨）

### Render.com（推奨）

1. [Render.com](https://render.com/)にサインアップ
2. 「New +」→「Web Service」を選択
3. GitHubリポジトリを接続
4. 以下の設定を入力：
   - **Build Command**: `npm install`
   - **Start Command**: `npm start`
5. 「Create Web Service」をクリック

### Railway.app

1. [Railway.app](https://railway.app/)にサインアップ
2. 「New Project」→「Deploy from GitHub repo」を選択
3. リポジトリを選択
4. 自動的にデプロイが開始されます

### VPS（より高度なユーザー向け）

1. VPS（ConoHa、さくらのVPSなど）にNode.jsをインストール
2. プロジェクトファイルをアップロード
3. `npm install`で依存関係をインストール
4. PM2などのプロセスマネージャーでサーバーを起動：
```bash
npm install -g pm2
pm2 start server.js --name "radio-request"
pm2 save
pm2 startup
```

## トラブルシューティング

### サーバーが起動しない

**症状**: `npm start`を実行してもエラーが出る

**解決方法**:
1. Node.jsがインストールされているか確認：`node --version`
2. 依存パッケージを再インストール：`rm -rf node_modules && npm install`
3. ポート3000が既に使用されていないか確認

### データベースエラー

**症状**: データの保存や取得ができない

**解決方法**:
1. `requests.db`ファイルの権限を確認
2. データベースファイルを削除して再生成：`rm requests.db && npm start`

### CAPTCHAが表示されない

**症状**: リクエストフォームでCAPTCHAが「読み込み中...」のまま

**解決方法**:
1. ブラウザのコンソールでエラーを確認
2. サーバーが正常に動作しているか確認
3. ブラウザのキャッシュをクリア

### 管理画面にログインできない

**症状**: パスワードが正しいのにログインできない

**解決方法**:
1. デフォルトパスワード`admin123`を確認
2. ブラウザのCookieを削除
3. データベースを再生成

## ライセンス

MIT License

## サポート

問題が発生した場合や質問がある場合は、以下を確認してください：

1. このREADMEファイルの「トラブルシューティング」セクション
2. ブラウザの開発者ツールのコンソール（F12キー）
3. サーバーのログ出力

## 開発者向け情報

### API エンドポイント一覧

#### 公開API
- `GET /api/captcha` - CAPTCHA生成
- `POST /api/requests` - リクエスト送信
- `GET /api/requests/today` - 今日のリクエスト一覧取得

#### 管理者API（認証必要）
- `POST /api/admin/login` - ログイン
- `POST /api/admin/logout` - ログアウト
- `GET /api/admin/check` - 認証状態確認
- `GET /api/admin/requests` - 全リクエスト取得
- `PATCH /api/admin/requests/:id/read` - 既読/未読切り替え
- `DELETE /api/admin/requests/:id` - リクエスト削除
- `GET /api/admin/export` - CSVエクスポート
- `GET /api/admin/stats` - 統計情報取得

### 今後の機能拡張アイデア

- リクエスト曲の検索機能
- リクエストへのコメント機能
- 週間/月間の人気曲ランキング
- リクエスト状態（未処理/放送済み/保留）の管理
- メール通知機能
- ソーシャルログイン
- 多言語対応

## 更新履歴

### v1.0.0（2024-10-22）
- 初回リリース
- 基本的なリクエスト受付機能
- 今日のリクエスト一覧表示
- 管理画面実装
- CSVエクスポート機能
